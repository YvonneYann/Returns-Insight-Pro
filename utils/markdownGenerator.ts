
import { AnalyzedStatusData } from './statusAnalyzer';
import { formatNumber, formatPercent } from './formatters';

// Helper to convert the specific HTML structure of AI insights to Structured Markdown
const convertHtmlToMarkdown = (html: string): string => {
  if (!html) return "";

  let md = html;
  
  // 0. Pre-clean: Remove comments
  md = md.replace(/<!--[\s\S]*?-->/g, ''); 
  
  // 1. Semantic Mapping: Product Portrait
  md = md.replace(
    /(?:<span[^>]*>\s*ğŸ“¦\s*<\/span>\s*)?<h3[^>]*>\s*(?:ğŸ“¦)?\s*äº§å“ç”»åƒä¸åŸºæœ¬æƒ…å†µ\s*<\/h3>[\s\S]*?<div[^>]*class="p-6"[^>]*>\s*<p[^>]*>/gi, 
    '\n### ğŸ“¦ äº§å“ç”»åƒä¸åŸºæœ¬æƒ…å†µ\n> '
  );

  // 2. Semantic Mapping: Diagnosis Matrix Header
  md = md.replace(/(<span[^>]*>1\. æ ‡é¢˜æè¿°.*?<\/span>)/, '\n---\n\n### ğŸ›¡ï¸ æ·±åº¦å½’å› è¯Šæ–­çŸ©é˜µ\n\n$1');

  // 3. Semantic Mapping: Row Headers
  md = md.replace(/<span[^>]*>(1\. æ ‡é¢˜æè¿°.*?)<\/span>/g, '#### $1');
  md = md.replace(/<span[^>]*>(2\. äº”ç‚¹æè¿°.*?)<\/span>/g, '#### $1');

  // 4. Linearization: Flatten the Grid Columns
  md = md.replace(/<h4[^>]*>\s*é—®é¢˜åˆ†æï¼š\s*<\/h4>/g, '\n**âŒ é—®é¢˜è¯Šæ–­ (Root Cause)**:');
  md = md.replace(/<h4[^>]*>\s*ä¼˜åŒ–é€»è¾‘ï¼š\s*<\/h4>/g, '\n**ğŸ’¡ ä¼˜åŒ–æ€è·¯**:');
  md = md.replace(/<h4[^>]*>\s*ä¼˜åŒ–å»ºè®®ï¼š\s*<\/h4>/g, '\n**âœ… ä¼˜åŒ–å»ºè®® (Action Plan)**:');

  // 5. Tag Conversion
  md = md.replace(/<ul[^>]*>/g, '');
  md = md.replace(/<\/ul>/g, '\n');
  md = md.replace(/<li[^>]*>\s*/g, '\n* '); 
  md = md.replace(/<\/li>/g, '');

  md = md.replace(/<strong[^>]*>(.*?)<\/strong>/g, '**$1**');
  md = md.replace(/<b[^>]*>(.*?)<\/b>/g, '**$1**');

  md = md.replace(/<p[^>]*>/g, '');
  md = md.replace(/<\/p>/g, '\n\n');
  md = md.replace(/<div[^>]*>/g, '\n'); 
  md = md.replace(/<\/div>/g, '\n');

  md = md.replace(/ğŸš« æ ¹æœ¬åŸå› .*?\(Root Cause\)/g, '');
  md = md.replace(/âœ… è¡ŒåŠ¨å»ºè®®.*?\(Action Plan\)/g, '');

  md = md.replace(/<[^>]+>/g, '');
  md = md.replace(/\n\s*\n\s*\n/g, '\n\n');
  md = md.replace(/\n\*\s+/g, '\n* ');
  md = md.split('\n').map(line => line.trim()).join('\n');
  
  return md.trim();
};

export const generateStatusMarkdown = (data: AnalyzedStatusData, aiInsights?: Record<string, string>): string => {
  const { narrative, statistics, groups, entities } = data;
  const isPurchase = data.reportMode === 'purchase';

  // --- Helper to generate ASIN tables ---
  const generateAsinTable = (items: any[], showStatusIcon = false) => {
    if (items.length === 0) return '_æš‚æ— æ•°æ®_';
    
    let header = `| ASIN | Sales Share | Returns Share | Return Rate |${showStatusIcon ? ' Status |' : ''}\n`;
    header += `| :--- | :--- | :--- | :--- |${showStatusIcon ? ' :--- |' : ''}\n`;
    
    const rows = items.map(item => {
      const rateStr = formatPercent(item.returnRate);
      const isRisk = item.returnRate > 0.1;
      const rateCell = isRisk ? `**${rateStr}**` : rateStr;
      const statusCell = showStatusIcon ? ` ${item.statusIcon} ${item.statusLabel} |` : '';
      
      return `| ${item.asin} | ${formatPercent(item.salesShare)} | ${formatPercent(item.returnsShare)} | ${rateCell} |${statusCell}`;
    }).join('\n');

    return header + rows;
  };

  let markdown = `# ${data.reportTitle}
> **Generated by**: Returns Insight Pro
> **Date**: ${data.reportDate}
> **Scope**: ${narrative.country} Station | Parent ASIN: \`${narrative.fasin}\` | Period: ${narrative.period}
> **Methodology**: ${data.methodology}

`;

  // Render Data Integrity Warning Block
  if (data.integrityWarning?.isIncomplete) {
    markdown += `> âš ï¸ **æ•°æ®å®Œæ•´æ€§é¢„è­¦ (Data Integrity Warning)**
> ç»Ÿè®¡ç»“æŸæ—¥æœŸè·ä»Šä¸è¶³ 30 å¤©ï¼Œç”±äºäºšé©¬é€Šé€€è´§å­˜åœ¨æ—¶é—´æ»åï¼ˆReturn Lagï¼‰ï¼Œè¿‘æœŸçš„é€€è´§æ•°æ®å°šæœªå®Œå…¨å›æµã€‚
> **å½“å‰æŠ¥å‘Šä¸­çš„é€€è´§ç‡æ•°æ®å¯èƒ½åä½ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸å»ºè®®ä½œä¸ºæœ€ç»ˆè€ƒæ ¸ä¾æ®ã€‚**
> *é¢„è®¡æ•°æ®å®Œå…¨æ²‰æ·€è¿˜éœ€çº¦ ${data.integrityWarning.daysToWait} å¤©ã€‚*

`;
  }

  markdown += `## 1. Narrative (å™äº‹å±‚ - ä¸šåŠ¡å…¨æ™¯)

**Health Status**: ${narrative.healthEmoji} **${narrative.healthLabel} (${narrative.healthStatus})**
**Attribution Logic**: ${isPurchase ? 'ğŸ›’ Based on Order Date (ä¸‹å•å½’å› )' : 'ğŸ“… Based on Return Event (é€€è´§å½’å› )'}
*${isPurchase ? 'Cohort Return Rate' : 'Current Return Rate'} ${statistics.returnRateFormatted} vs. Threshold 10%*

**Strategic Overview (ä¸šåŠ¡è§£è¯»)**:
> ${narrative.strategicOverview}

---

## 2. Statistics (ç»Ÿè®¡å±‚ - ç»“æ„åŒ–åˆ†å¸ƒ)

### 2.1 Global Metrics (æ ¸å¿ƒæŒ‡æ ‡)
| Metric | Value |
| :--- | :--- |
| **Total Units Sold** | **${formatNumber(statistics.totalSold)}** |
| Total Returns | ${formatNumber(statistics.totalReturns)} |
| **${isPurchase ? 'Cohort Return Rate (æ‰¹æ¬¡é€€è´§ç‡)' : 'Blended Return Rate (ç»¼åˆé€€è´§ç‡)'}** | **${statistics.returnRateFormatted}** |

### 2.2 Structural Segmentation (é˜µè¥æ‹†è§£)

${groups.classA.count > 0 ? `#### ğŸ”µ Class A: Main Battlefield (ä¸»æˆ˜åœºæ¬¾)
*   **Summary**: æœ¬æœŸå…±æœ‰ **${groups.classA.count}** ä¸ªæ ¸å¿ƒ ASINã€‚
*   **Impact**: åˆè®¡è´¡çŒ®é”€é‡ **${formatPercent(groups.classA.totalSalesShare)}** | é€€è´§é‡ **${formatPercent(groups.classA.totalReturnsShare)}**ã€‚
*   **Insight**: ${groups.classA.insight}

**ASIN Detail List**:
${generateAsinTable(groups.classA.items, true)}` : `#### ğŸ”µ Class A: Main Battlefield (ä¸»æˆ˜åœºæ¬¾)
> *æœ¬æœŸæœªè¯†åˆ«åˆ°æ ¸å¿ƒä¸»æˆ˜åœºæ¬¾ ASINã€‚*`}

${groups.classB.count > 0 ? `#### ğŸ”´ Class B: Problematic High-Risk (é«˜é€€è´§é—®é¢˜æ¬¾)
*   **Summary**: æœ¬æœŸå…±æœ‰ **${groups.classB.count}** ä¸ªé«˜é€€è´§é—®é¢˜ ASINã€‚
*   **Impact**: åˆè®¡é”€é‡å æ¯” **${formatPercent(groups.classB.totalSalesShare)}** | é€€è´§å æ¯” **${formatPercent(groups.classB.totalReturnsShare)}**ã€‚
*   **Critical Metric**: **è¯¥ç»„å¹³å‡é€€è´§ç‡ä¸º ${formatPercent(groups.classB.avgReturnRate)} (æ˜¾è‘—é«˜äºçˆ¶ä½“ ${statistics.returnRateFormatted})**ã€‚
*   **Insight**: ${groups.classB.insight}

**ASIN Detail List**:
${generateAsinTable(groups.classB.items, false)}` : `#### ğŸ”´ Class B: Problematic High-Risk (é«˜é€€è´§é—®é¢˜æ¬¾)
> âœ… **Good Job!** æœ¬æœŸè¡¨ç°è‰¯å¥½ï¼Œæœªå‘ç°é«˜é€€è´§é—®é¢˜æ¬¾ ASINã€‚`}

${groups.watchlist.count > 0 ? `#### ğŸŸ¡ Watchlist (é«˜é€€è´§è§‚å¯Ÿå¯¹è±¡)
*   **Summary**: å…±æœ‰ **${groups.watchlist.count}** ä¸ªå°ä½“é‡ ASIN çº³å…¥è§‚å¯Ÿã€‚
*   **Impact**: åˆè®¡è´¡çŒ®é”€é‡ **${formatPercent(groups.watchlist.totalSalesShare)}** | é€€è´§é‡ **${formatPercent(groups.watchlist.totalReturnsShare)}**ã€‚
*   **Insight**: ${groups.watchlist.insight}

**ASIN Detail List**:
${generateAsinTable(groups.watchlist.items, false)}` : `#### ğŸŸ¡ Watchlist (é«˜é€€è´§è§‚å¯Ÿå¯¹è±¡)
> *æœ¬æœŸæš‚æ— æ–°å¢é«˜é€€è´§è§‚å¯Ÿå¯¹è±¡ã€‚*`}

---

## 3. Entities (å®ä½“å±‚ - æ·±åº¦å½’å› ä¸è¯Šæ–­)

> æœ¬éƒ¨åˆ†é’ˆå¯¹ **Class A** ä¸ **Class B** ä¸­çš„é‡ç‚¹ ASIN è¿›è¡Œè¯¦ç»†æ‹†è§£ã€‚

${entities.map(entity => {
  const topReason = entity.topReasons[0] || { name: 'N/A', pct: 0, count: 0 };
  
  // Generate Table Rows for Top 3 Reasons
  const topReasonsRows = entity.topReasons.slice(0, 3).map((r, i) => {
      const isFirst = i === 0;
      const name = isFirst ? `**${r.name}**` : r.name;
      const pct = isFirst ? `**${formatPercent(r.pct)}**` : formatPercent(r.pct);
      return `| ${i + 1} | ${name} | ${pct} | ${r.count} |`;
  }).join('\n');

  const existingInsightHtml = aiInsights ? aiInsights[entity.asin] : null;

  return `### ğŸ“¦ ASIN: ${entity.asin}
*   **Tag**: ${entity.problemClass === 'B' ? 'ğŸ”´' : 'ğŸ”µ'} ${entity.problemClassLabel}
*   **Metrics**: Returns: ${formatNumber(entity.unitsReturned)} | Coverage: ${formatPercent(entity.textCoverage)}
*   **Confidence**: ${entity.confidenceLevel} (${entity.confidenceLabel}) - Based on ${entity.totalEvents} events

#### 3.1 Top Return Reasons (æ•°æ®å½’å› )
| Rank | Reason Code | Pct | Event Count |
| :--- | :--- | :--- | :--- |
${topReasonsRows}

#### 3.2 User Voice Evidence (ç”¨æˆ·åŸå£°é€è§†)
${entity.evidenceText 
  ? entity.evidenceText.split('\n').map(line => `> *${line}*`).join('\n') 
  : '> _æš‚æ— è¶³å¤Ÿçš„ç”¨æˆ·åŸå£°æ•°æ®_'}

#### 3.3 ğŸ¤– AI Intelligence Context (æ™ºèƒ½å½’å› è¯Šæ–­)

${existingInsightHtml 
  ? convertHtmlToMarkdown(existingInsightHtml) 
  : `*(æœªåœ¨ UI ä¸­ç”Ÿæˆ AI è¯Šæ–­ï¼Œä»¥ä¸‹æä¾› Context ä¾› AI Agent è¯»å–)*

**[Context A] Listing Claims (äº§å“æ‰¿è¯º)**
*   **Title**: ${entity.listingContext?.title || "N/A"}
*   **Key Features (Bullet Points)**:
${entity.listingContext?.features ? entity.listingContext.features.split('\n').map(f => `    * ${f}`).join('\n') : "    * N/A"}
*   **Product Description**:
    > ${entity.listingContext?.description ? entity.listingContext.description.replace(/\n/g, ' ') : "N/A"}

**[Context B] Diagnosis Protocol (è¯Šæ–­æŒ‡ä»¤)**
*   **Input 1**: Context A (Marketing Claims)
*   **Input 2**: Section 3.2 (User Evidence: "${topReason.name}")
*   **Task**: 
    1.  **Cross-Check**: Contrast the user feedback with the specific bullet points above. 
    2.  **Root Cause**: Is this a "Quality Failure" (product broke) or "Expectation Gap" (misleading description)?
    3.  **Action**: Suggest specific edits to the Listing text to manage expectations (e.g. "Add compatibility note to Bullet Point #2").`}
`;
}).join('\n\n---\n\n')}

---
*End of Report*
`;

  return markdown;
};
